# üê≥ Comparativo de Builds Docker: Tradicional vs Distroless vs Melange+Apko

[![Docker](https://img.shields.io/badge/Docker-2496ED?style=for-the-badge&logo=docker&logoColor=white)](https://www.docker.com/)
[![Python](https://img.shields.io/badge/Python-3776AB?style=for-the-badge&logo=python&logoColor=white)](https://www.python.org/)
[![Flask](https://img.shields.io/badge/Flask-000000?style=for-the-badge&logo=flask&logoColor=white)](https://flask.palletsprojects.com/)
[![Security](https://img.shields.io/badge/Security-Trivy-4B275F?style=for-the-badge&logo=aqua&logoColor=white)](https://trivy.dev/)
[![License](https://img.shields.io/badge/License-MIT-yellow.svg?style=for-the-badge)](LICENSE)

> **Estudo comparativo de seguran√ßa e performance** entre diferentes estrat√©gias de containeriza√ß√£o

Este reposit√≥rio demonstra **tr√™s abordagens diferentes** para criar imagens Docker de uma aplica√ß√£o Flask simples que gera senhas aleat√≥rias, comparando **seguran√ßa, tamanho e complexidade** com an√°lises detalhadas usando Trivy.

## üìã Vis√£o Geral dos Projetos

| Projeto                   | Abordagem              | Tamanho | Seguran√ßa | Complexidade |
| ------------------------- | ---------------------- | ------- | --------- | ------------ |
| **01-build-convencional** | Dockerfile tradicional | ~140MB  | ‚ö†Ô∏è Baixa  | üü¢ Simples   |
| **02-build-distroless**   | Chainguard Distroless  | ~64MB   | üü° M√©dia  | üü° Moderada  |
| **03-melange**            | Melange + Apko         | ~42MB   | üü¢ Alta   | üî¥ Avan√ßada  |

---

## üöÄ Quick Start

### Pr√©-requisitos

- [Docker](https://docs.docker.com/get-docker/) 20.10+ (inclui Docker Scout)
- [Trivy](https://trivy.dev/v0.65/getting-started/installation/) (para an√°lise de seguran√ßa)
- [Docker Scout](https://docs.docker.com/scout/) (an√°lise complementar)
- [Melange](https://github.com/chainguard-dev/melange) e [Apko](https://github.com/chainguard-dev/apko) (apenas para abordagem 03)

### Instala√ß√£o R√°pida das Ferramentas

```bash
# Trivy - Linux/macOS
curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

# Trivy via package manager
brew install trivy  # macOS
apt-get install trivy  # Ubuntu/Debian

# Docker Scout (j√° inclu√≠do no Docker 24.0+)
docker scout --help

# Docker Scout CLI standalone (opcional)
curl -sSfL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh | sh -s --
```

---

## üóÇ Estrutura do Reposit√≥rio

```
.
‚îú‚îÄ‚îÄ 01-build-convencional/    # Build tradicional com Dockerfile
‚îú‚îÄ‚îÄ 02-build-distroless/      # Build com imagens Chainguard
‚îú‚îÄ‚îÄ 03-melange/               # Build com Melange + Apko
‚îú‚îÄ‚îÄ LICENSE
‚îî‚îÄ‚îÄ README.md                 # Este arquivo
```

---

## üìÅ 01-build-convencional

**Abordagem**: Dockerfile tradicional com imagem Python oficial

### Caracter√≠sticas

- ‚úÖ **Simplicidade**: Dockerfile padr√£o, f√°cil de entender
- ‚úÖ **Compatibilidade**: Funciona em qualquer ambiente Docker
- ‚ùå **Tamanho**: ~140MB (imagem completa do Ubuntu/Debian)
- ‚ùå **Seguran√ßa**: Muitos pacotes desnecess√°rios
- ‚ùå **Vulnerabilidades**: Sistema operacional completo

### Estrutura

```
01-build-convencional/
‚îú‚îÄ‚îÄ Dockerfile              # Build tradicional
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app.py             # Aplica√ß√£o Flask
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt   # Depend√™ncias Python
‚îî‚îÄ‚îÄ README.md
```

### Como usar

```bash
cd 01-build-convencional
docker build -t app-convencional .
docker run -p 5000:5000 app-convencional
```

---

## üìÅ 02-build-distroless

**Abordagem**: Imagens Chainguard Python (distroless)

### Caracter√≠sticas

- ‚úÖ **Seguran√ßa**: Sem shell, sem pacotes desnecess√°rios
- ‚úÖ **Tamanho**: ~64MB (redu√ß√£o de 54%)
- ‚úÖ **Vulnerabilidades**: Muito reduzidas
- ‚úÖ **Atualiza√ß√µes**: Imagens mantidas pela Chainguard
- üü° **Complexidade**: Requer conhecimento de distroless

### Estrutura

```
02-build-distroless/
‚îú‚îÄ‚îÄ Dockerfile              # Build com Chainguard
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app.py             # Aplica√ß√£o Flask
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt   # Depend√™ncias Python
‚îî‚îÄ‚îÄ README.md
```

### Como usar

```bash
cd 02-build-distroless
docker build -t app-distroless .
docker run -p 5000:5000 app-distroless
```

---

## üìÅ 03-melange

**Abordagem**: Melange + Apko (Supply Chain Security)

### Caracter√≠sticas

- ‚úÖ **M√°xima Seguran√ßa**: SBOM autom√°tico, assinatura de pacotes
- ‚úÖ **Menor Tamanho**: ~42MB (uma √∫nica camada)
- ‚úÖ **Reproduz√≠vel**: Builds id√™nticos sempre
- ‚úÖ **Audit√°vel**: Rastreabilidade completa
- ‚úÖ **Performance**: Startup mais r√°pido
- üî¥ **Complexidade**: Requer Melange e Apko instalados

### Estrutura

```
03-melange/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app.py              # Aplica√ß√£o Flask
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt    # Depend√™ncias Python
‚îú‚îÄ‚îÄ melange.yaml           # Configura√ß√£o do Melange
‚îú‚îÄ‚îÄ apko.yaml              # Configura√ß√£o do Apko
‚îú‚îÄ‚îÄ build-oficial.sh       # Script automatizado
‚îî‚îÄ‚îÄ README.md
```

### Como usar

```bash
cd 03-melange
./build-oficial.sh
# Pressione Ctrl+C para parar e limpar arquivos tempor√°rios
```

---

## üéØ Quando Usar Cada Abordagem

### üü¢ Build Convencional

**Use quando:**

- Prototipagem r√°pida
- Desenvolvimento local
- Equipe iniciante em containers
- N√£o h√° requisitos rigorosos de seguran√ßa

### üü° Build Distroless

**Use quando:**

- Produ√ß√£o com requisitos de seguran√ßa
- Quer reduzir vulnerabilidades sem complexidade
- Precisa de imagens menores
- Tem experi√™ncia com containers

### üî¥ Build Melange + Apko

**Use quando:**

- M√°xima seguran√ßa √© cr√≠tica
- Compliance rigoroso (SBOM, assinatura)
- Aplica√ß√µes de alta performance
- Supply chain security √© prioridade
- Tem expertise em ferramentas Chainguard

---

## üîí An√°lise de Seguran√ßa com Trivy e Docker Scout

### Resultados do Scan de Vulnerabilidades

| Abordagem              | Total Vulnerabilidades | Cr√≠ticas | Altas | M√©dias | Baixas | Tamanho |
| ---------------------- | ---------------------- | -------- | ----- | ------ | ------ | ------- |
| **Build Convencional** | 53                     | 0        | 2     | 0      | 51     | ~140MB  |
| **Build Distroless**   | **0** ‚úÖ               | 0        | 0     | 0      | 0      | ~64MB   |
| **Melange + Apko**     | **0** ‚úÖ               | 0        | 0     | 0      | 0      | ~42MB   |

### Detalhes - Build Convencional

**Vulnerabilidades por Categoria:**

- **Sistema Operacional (Debian 13.0)**: 51 vulnerabilidades LOW
- **Depend√™ncias Python**: 2 vulnerabilidades HIGH

**Principais Vulnerabilidades HIGH:**

- `CVE-2024-6345` - setuptools: Remote code execution via download functions
- `CVE-2025-47273` - setuptools: Path Traversal Vulnerability

### Detalhes - Build Distroless ‚úÖ

**Resultado Chainguard Distroless:**

- **Sistema Operacional (Wolfi)**: 0 vulnerabilidades
- **Depend√™ncias Python**: 0 vulnerabilidades
- **Total**: **ZERO vulnerabilidades** ‚úÖ

**Implementa√ß√£o Atual:**

1. **Base Chainguard**: Multi-stage com `cgr.dev/chainguard/python`
2. **Builder stage**: `cgr.dev/chainguard/python:latest-dev`
3. **Runtime stage**: `cgr.dev/chainguard/python:latest`
4. **‚úÖ Resultado**: Seguran√ßa m√°xima com Wolfi base

### Detalhes - Build Melange + Apko ‚úÖ

**Resultado Excepcional:**

- **Sistema Operacional (Alpine Edge)**: 0 vulnerabilidades
- **Depend√™ncias Python**: 0 vulnerabilidades (integradas no build)
- **Total**: **ZERO vulnerabilidades encontradas**

**Por que zero vulnerabilidades?**

1. **Alpine Edge minimalista**: Base ultra-enxuta com apenas 20 pacotes
2. **Build customizado**: Melange compila apenas o necess√°rio
3. **Sem arquivos de desenvolvimento**: Apko gera imagem final limpa
4. **Controle total**: Cada componente √© explicitamente definido

### üéØ Impacto dos Resultados

| M√©trica                     | Convencional | Distroless | Melange | Melhor Resultado |
| --------------------------- | ------------ | ---------- | ------- | ---------------- |
| **Vulnerabilidades Totais** | 53           | 0          | 0       | **-100%** ‚úÖ     |
| **Vulnerabilidades HIGH**   | 2            | 0          | 0       | **-100%** ‚úÖ     |
| **Tamanho da Imagem**       | ~140MB       | ~64MB      | ~42MB   | **-70%** ‚úÖ      |
| **Pacotes do SO**           | 87           | 24         | 20      | **-77%** ‚úÖ      |

**Conclus√µes Finais:**

- **üèÜ Empate na seguran√ßa**: Distroless e Melange eliminam 100% das vulnerabilidades
- **üéØ Chainguard √© superior**: Wolfi base ultra-segura
- **üìä Ranking correto**: Distroless = Melange > Convencional
- **‚úÖ Objetivo alcan√ßado**: Distroless agora tem menos vulnerabilidades que convencional

**Como executar o scan:**

```bash
# Instalar Trivy (se n√£o tiver)
curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

# Scan da imagem convencional
trivy image app-convencional

# Scan com formato JSON para an√°lise detalhada
trivy image --format json --output results.json app-convencional

# Scan apenas vulnerabilidades cr√≠ticas e altas
trivy image --severity CRITICAL,HIGH app-convencional

# Scan da imagem distroless (confirmado: 0 vulnerabilidades)
trivy image app-distroless
```

**Recomenda√ß√µes Baseadas nos Resultados:**

1. **‚ùå Evitar build convencional** para produ√ß√£o (53 vulnerabilidades)
2. **‚úÖ Usar Distroless** para facilidade + seguran√ßa (0 vulnerabilidades, 64MB)
3. **üèÜ Usar Melange** para m√°xima otimiza√ß√£o (0 vulnerabilidades, 42MB)
4. **Implementar scanning cont√≠nuo** no pipeline CI/CD com Trivy

### Pr√≥ximos Testes

Para completar a an√°lise comparativa, execute:

```bash
# Scan das outras abordagens
trivy image app-distroless
trivy image app-melange  # ou nome da imagem gerada pelo Apko

# Compara√ß√£o lado a lado
echo "=== CONVENCIONAL ===" && trivy image --quiet app-convencional
echo "=== DISTROLESS ===" && trivy image --quiet app-distroless
echo "=== MELANGE ===" && trivy image --quiet app-melange
```

**Resultados Finais:**

- **Chainguard Distroless**: ‚úÖ **ZERO vulnerabilidades** - Wolfi base ultra-segura
- **Melange**: ‚úÖ **ZERO vulnerabilidades** - Alpine base ultra-segura

---

## üõ°Ô∏è An√°lise Complementar com Docker Scout

O **Docker Scout** oferece an√°lises mais detalhadas e integra√ß√£o nativa com o ecossistema Docker, complementando perfeitamente o Trivy.

### Instala√ß√£o do Docker Scout

```bash
# Docker Scout j√° vem integrado no Docker Desktop
# Para CLI standalone:
curl -sSfL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh | sh -s --

# Ou via Docker:
docker scout --help
```

### Comandos de An√°lise

#### An√°lise B√°sica de Vulnerabilidades

```bash
# Scan b√°sico da imagem
docker scout cves app-convencional
docker scout cves app-distroless
docker scout cves app-melange

# Scan com detalhes completos
docker scout cves --details app-convencional

# Apenas vulnerabilidades cr√≠ticas e altas
docker scout cves --only-severity critical,high app-convencional
```

#### Compara√ß√£o Entre Imagens

```bash
# Comparar duas imagens diretamente
docker scout compare app-convencional --to app-distroless

# Comparar com imagem base
docker scout compare app-convencional --to python:3.11-slim

# Ver diferen√ßas em formato JSON
docker scout compare app-convencional --to app-distroless --format json
```

#### An√°lise de Recomenda√ß√µes

```bash
# Recomenda√ß√µes de atualiza√ß√£o
docker scout recommendations app-convencional

# An√°lise de supply chain
docker scout sbom app-convencional

# Verificar pol√≠ticas de seguran√ßa
docker scout policy app-convencional
```

### Vantagens do Docker Scout vs Trivy

| Recurso                   | Docker Scout   | Trivy | Observa√ß√µes                           |
| ------------------------- | -------------- | ----- | ------------------------------------- |
| **Integra√ß√£o Docker**     | ‚úÖ Nativa      | üü°    | Scout integrado ao Docker CLI         |
| **Compara√ß√£o de Imagens** | ‚úÖ Avan√ßada    | ‚ùå    | Scout permite compara√ß√£o direta       |
| **Recomenda√ß√µes**         | ‚úÖ Inteligente | üü°    | Scout sugere atualiza√ß√µes espec√≠ficas |
| **SBOM Generation**       | ‚úÖ Completo    | ‚úÖ    | Ambos geram SBOM detalhado            |
| **Base de Dados**         | Docker         | Multi | Scout usa dados do Docker Hub         |
| **Performance**           | üü° Moderada    | ‚úÖ    | Trivy √© mais r√°pido                   |
| **Formato de Sa√≠da**      | JSON/Texto     | Multi | Trivy tem mais formatos               |

### Exemplo de An√°lise Completa

```bash
#!/bin/bash
# Script de an√°lise completa com Docker Scout

echo "üîç An√°lise Docker Scout - Comparativo de Seguran√ßa"
echo "=================================================="

# Build das imagens (se necess√°rio)
echo "üì¶ Construindo imagens..."
cd 01-build-convencional && docker build -t app-convencional . && cd ..
cd 02-build-distroless && docker build -t app-distroless . && cd ..

echo ""
echo "üõ°Ô∏è An√°lise de Vulnerabilidades:"
echo "--------------------------------"

# An√°lise individual
echo "üìä App Convencional:"
docker scout cves --only-severity critical,high app-convencional

echo ""
echo "üìä App Distroless:"
docker scout cves --only-severity critical,high app-distroless

echo ""
echo "üîÑ Compara√ß√£o Direta:"
echo "--------------------"
docker scout compare app-convencional --to app-distroless

echo ""
echo "üí° Recomenda√ß√µes:"
echo "----------------"
docker scout recommendations app-convencional
```

### Integra√ß√£o com CI/CD

```yaml
# Exemplo para GitHub Actions
name: Docker Scout Security Scan

on: [push, pull_request]

jobs:
  scout-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: docker build -t ${{ github.repository }}:${{ github.sha }} .

      - name: Docker Scout scan
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ github.repository }}:${{ github.sha }}
          only-severities: critical,high
          exit-code: true
```

### Resultados Esperados

Com base nos testes com Trivy, esperamos que o Docker Scout confirme:

| Imagem               | Vulnerabilidades Scout | Recomenda√ß√µes                 |
| -------------------- | ---------------------- | ----------------------------- |
| **app-convencional** | ~50+ vulnerabilidades  | Migrar para imagem distroless |
| **app-distroless**   | 0-2 vulnerabilidades   | Manter atualizada             |
| **app-melange**      | 0 vulnerabilidades     | Configura√ß√£o ideal ‚úÖ         |

### Comandos de Teste R√°pido

```bash
# Teste r√°pido de todas as imagens
for image in app-convencional app-distroless app-melange; do
  echo "=== Analisando $image ==="
  docker scout cves --only-severity critical,high $image
  echo ""
done

# Compara√ß√£o em cadeia
docker scout compare app-convencional --to app-distroless --to app-melange
```

---

## üì¶ Exemplos Prontos para Uso

### Script de An√°lise de Seguran√ßa Completa

Execute o script `security-analysis.sh` para an√°lise completa com Trivy e Docker Scout:

```bash
# Tornar execut√°vel e executar
chmod +x security-analysis.sh
./security-analysis.sh
```

### Script de Compara√ß√£o Autom√°tica

Execute o script `compare-all.sh` para testar todas as abordagens automaticamente:

```bash
# Tornar execut√°vel e executar
chmod +x compare-all.sh
./compare-all.sh
```

### Comandos Individuais

Para comparar todas as tr√™s abordagens manualmente:

```bash
# 1. Build Convencional
cd 01-build-convencional && docker build -t app-convencional . && cd ..

# 2. Build Distroless
cd 02-build-distroless && docker build -t app-distroless . && cd ..

# 3. Build Melange
cd 03-melange && ./build-oficial.sh
# (Pressione Ctrl+C ap√≥s testar)

# Comparar tamanhos
docker images | grep app-
```

---

## üìö Recursos Adicionais

### Ferramentas de Seguran√ßa

- [Trivy Documentation](https://trivy.dev/)
- [Docker Scout Documentation](https://docs.docker.com/scout/)
- [Docker Scout CLI](https://github.com/docker/scout-cli)

### Tecnologias Utilizadas

- [Documenta√ß√£o Chainguard](https://edu.chainguard.dev/)
- [Melange Documentation](https://github.com/chainguard-dev/melange)
- [Apko Documentation](https://github.com/chainguard-dev/apko)
- [Distroless Best Practices](https://github.com/GoogleContainerTools/distroless)

### Scripts de Automa√ß√£o

- `security-analysis.sh` - An√°lise completa com Trivy e Docker Scout
- `compare-all.sh` - Compara√ß√£o automatizada das tr√™s abordagens

---

## üõ†Ô∏è Desenvolvimento

### Estrutura de Arquivos

```
.
‚îú‚îÄ‚îÄ 01-build-convencional/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile              # Build tradicional
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.py             # Aplica√ß√£o Flask
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt   # Depend√™ncias
‚îÇ   ‚îî‚îÄ‚îÄ README.md              # Documenta√ß√£o espec√≠fica
‚îú‚îÄ‚îÄ 02-build-distroless/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile              # Build Chainguard
‚îÇ   ‚îî‚îÄ‚îÄ src/                   # Mesma aplica√ß√£o
‚îú‚îÄ‚îÄ 03-melange/
‚îÇ   ‚îú‚îÄ‚îÄ melange.yaml           # Configura√ß√£o Melange
‚îÇ   ‚îú‚îÄ‚îÄ apko.yaml              # Configura√ß√£o Apko
‚îÇ   ‚îú‚îÄ‚îÄ build-oficial.sh       # Script de build
‚îÇ   ‚îî‚îÄ‚îÄ src/                   # Mesma aplica√ß√£o
‚îú‚îÄ‚îÄ compare-all.sh             # Script de compara√ß√£o
‚îî‚îÄ‚îÄ README.md                  # Este arquivo
```

### Testando Modifica√ß√µes

1. **Modificar a aplica√ß√£o**: Edite `src/app.py` em qualquer diret√≥rio
2. **Rebuild**: Execute `docker build -t <tag> .` no diret√≥rio
3. **Testar**: `docker run -p 5000:5000 <tag>`
4. **Analisar**: `trivy image <tag>`

### Adicionando Nova Abordagem

1. Crie um novo diret√≥rio `04-nova-abordagem/`
2. Adicione Dockerfile e documenta√ß√£o
3. Atualize `compare-all.sh`
4. Documente no README principal

---

## ü§ù Contribuindo

Contribui√ß√µes s√£o bem-vindas! Por favor:

1. **Fork** o reposit√≥rio
2. **Crie** uma branch para sua feature (`git checkout -b feature/nova-abordagem`)
3. **Commit** suas mudan√ßas (`git commit -am 'Adiciona nova abordagem X'`)
4. **Push** para a branch (`git push origin feature/nova-abordagem`)
5. **Abra** um Pull Request

### Tipos de Contribui√ß√µes

- üêõ **Bug fixes** em Dockerfiles
- üìö **Melhorias na documenta√ß√£o**
- üîí **Novas an√°lises de seguran√ßa**
- üöÄ **Novas abordagens de build**
- üìä **Benchmarks e compara√ß√µes**
